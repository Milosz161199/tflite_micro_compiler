
$(foreach setting, $(shell ../GET_PROJECT_SETTINGS.sh --makefile --id_prefix IFX_), $(eval $(setting)))
INSTALLED_TFLITE_MICRO=$(IFX_TOOLSPREFIX)/tflite_u-$(IFX_TFLITE_MICRO_VERSION)

COMPILED_FILES_SELECTION ?= generated
LOCAL_CPPFLAGS += -DTFLMC_USE_INTERPRETER_HOOKS

include $(INSTALLED_TFLITE_MICRO)/tools/make/Makefile

HOST_MAKE_ARGS = -f IFX_Makefile TARGET=$(HOST_OS) TARGET_ARCH=$(HOST_ARCH)

LOCAL_CLEANS = examples/generated

ifeq ($(OS),Windows_NT)
    EXE_SUFFIX=.exe
else
    LOCAL_LDFLAGS=-ldl
endif

EXAMPLE_TYPE ?= generated
COMPILER_EXE := $(GENDIR)bin/compiler$(EXE_SUFFIX)
EXAMPLE_NETS:=hello_world cifar10 mobilenet hello_world_5
EXAMPLES:=$(foreach e, $(EXAMPLE_NETS), $(e) $(e)_compiled )


.PHONY: examples run_examples regenerate regenerate_examples build_compiler

ifeq ($(TARGET),windows)
  TEST_RUNNER :=
else ifeq ($(TARGET),linux)
  TEST_RUNNER :=
else
  TEST_RUNNER := $(TEST_SCRIPT) --no-check
endif


regenerate:
	$(MAKE) $(HOST_MAKE_ARGS) compiler
	make $(HOST_MAKE_ARGS) regenerate_examples

examples:  regenerate
	$(MAKE) -f IFX_Makefile build_examples

build_examples: $(EXAMPLES)

run_examples:  examples
	set -e ; for f in $(EXAMPLES); do echo $${f}; $(TEST_RUNNER) $(GENDIR)bin/$${f}; done

COMPILED_EXAMPLES = $(foreach n, $(EXAMPLE_NETS), examples/generated/compiled_$(n).cc)

regenerate_examples: $(COMPILED_EXAMPLES)
	
examples/generated/compiled_%.cc: examples/%.tflite $(COMPILER_EXE)
	@mkdir -p examples/generated
	$(COMPILER_EXE) $< $@  $*_


install: compiler
	mkdir -p "${INSTALLED_TFLITE_MICRO}"/bin
	cp -a $(COMPILER_EXE) "${INSTALLED_TFLITE_MICRO}"/bin

